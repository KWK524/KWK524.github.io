<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS ê²½ë¡œ ì¶”ì ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #111;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #header {
            background: #1f2937;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        h1 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            gap: 1rem;
            overflow-y: auto;
        }
        #canvas-container {
            background: #1f2937;
            border-radius: 0.5rem;
            overflow: hidden;
            flex: 1;
            min-height: 300px;
            position: relative;
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
        .stat-card {
            background: #1f2937;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        .stat-label {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 0.25rem;
        }
        .stat-value {
            font-size: 1.25rem;
            font-weight: bold;
        }
        .location-info {
            background: #1f2937;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-family: monospace;
        }
        .location-label {
            color: #9ca3af;
            margin-bottom: 0.25rem;
        }
        .controls {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0.75rem;
        }
        button {
            padding: 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        button:active {
            transform: scale(0.98);
        }
        #startBtn {
            background: #10b981;
            color: #fff;
        }
        #startBtn:active {
            background: #059669;
        }
        #startBtn.tracking {
            background: #ef4444;
        }
        #startBtn.tracking:active {
            background: #dc2626;
        }
        #resetBtn {
            background: #374151;
            color: #fff;
        }
        #resetBtn:active {
            background: #4b5563;
        }
        #resetBtn:disabled {
            background: #1f2937;
            color: #6b7280;
        }
        #downloadBtn {
            background: #3b82f6;
            color: #fff;
            grid-column: 1 / -1;
        }
        #downloadBtn:active {
            background: #2563eb;
        }
        #downloadBtn:disabled {
            background: #1f2937;
            color: #6b7280;
        }
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        .info {
            background: #1f2937;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }
        .info strong {
            color: #fff;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ğŸ“ GPS ê²½ë¡œ ì¶”ì ê¸°</h1>
    </div>

    <div id="main">
        <div id="canvas-container">
            <canvas id="canvas"></canvas>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">ê¸°ë¡ì </div>
                <div class="stat-value" id="pointCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ê±°ë¦¬</div>
                <div class="stat-value" id="distance">0.00km</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì‹œê°„</div>
                <div class="stat-value" id="time">0:00:00</div>
            </div>
        </div>

        <div id="locationInfo" class="location-info hidden">
            <div class="location-label">í˜„ì¬ ìœ„ì¹˜</div>
            <div id="locationText"></div>
        </div>

        <div class="controls">
            <button id="startBtn">â–¶ ì‹œì‘</button>
            <button id="resetBtn">â†»</button>
        </div>

        <button id="downloadBtn" disabled>ğŸ’¾ ë°ì´í„° ì €ì¥</button>

        <div id="error" class="error hidden"></div>

        <div class="info">
            <strong>ğŸ’¡ ì‚¬ìš© íŒ</strong><br>
            â€¢ GPS ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”<br>
            â€¢ ì‹¤ì™¸ì—ì„œ ì‚¬ìš©í•˜ë©´ ì •í™•ë„ê°€ ë†’ì•„ì§‘ë‹ˆë‹¤<br>
            â€¢ ë…¹ìƒ‰=ì‹œì‘ì , ë¹¨ê°•=í˜„ì¬ìœ„ì¹˜
        </div>
    </div>

    <script>
        let isTracking = false;
        let points = [];
        let watchId = null;
        let startTime = null;
        let timerInterval = null;
        let totalDistance = 0;

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const errorDiv = document.getElementById('error');
        const locationInfo = document.getElementById('locationInfo');
        const locationText = document.getElementById('locationText');

        // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
        function resizeCanvas() {
            const container = document.getElementById('canvas-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            drawPath();
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ê±°ë¦¬ ê³„ì‚° (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // ê²½ë¡œ ê·¸ë¦¬ê¸°
        function drawPath() {
            const width = canvas.width;
            const height = canvas.height;

            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, width, height);

            if (points.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ì¶”ì ì„ ì‹œì‘í•˜ì„¸ìš”', width / 2, height / 2);
                return;
            }

            if (points.length === 1) {
                ctx.fillStyle = '#10b981';
                ctx.beginPath();
                ctx.arc(width / 2, height / 2, 10, 0, 2 * Math.PI);
                ctx.fill();
                return;
            }

            const lats = points.map(p => p.lat);
            const lons = points.map(p => p.lon);
            const minLat = Math.min(...lats);
            const maxLat = Math.max(...lats);
            const minLon = Math.min(...lons);
            const maxLon = Math.max(...lons);

            const latRange = maxLat - minLat || 0.001;
            const lonRange = maxLon - minLon || 0.001;

            const padding = 30;
            const drawWidth = width - 2 * padding;
            const drawHeight = height - 2 * padding;

            function toCanvas(lat, lon) {
                const x = padding + ((lon - minLon) / lonRange) * drawWidth;
                const y = height - padding - ((lat - minLat) / latRange) * drawHeight;
                return { x, y };
            }

            // ê²½ë¡œ ê·¸ë¦¬ê¸°
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();

            points.forEach((point, i) => {
                const { x, y } = toCanvas(point.lat, point.lon);
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // ì‹œì‘ì 
            const start = toCanvas(points[0].lat, points[0].lon);
            ctx.fillStyle = '#10b981';
            ctx.beginPath();
            ctx.arc(start.x, start.y, 10, 0, 2 * Math.PI);
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();

            // í˜„ì¬ ìœ„ì¹˜
            const end = toCanvas(points[points.length - 1].lat, points[points.length - 1].lon);
            ctx.fillStyle = '#ef4444';
            ctx.beginPath();
            ctx.arc(end.x, end.y, 12, 0, 2 * Math.PI);
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            document.getElementById('pointCount').textContent = points.length;
            document.getElementById('distance').textContent = (totalDistance / 1000).toFixed(2) + 'km';
            
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const h = Math.floor(elapsed / 3600);
                const m = Math.floor((elapsed % 3600) / 60);
                const s = elapsed % 60;
                document.getElementById('time').textContent = 
                    `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            errorDiv.classList.add('hidden');
        }

        // ì¶”ì  ì‹œì‘
        startBtn.addEventListener('click', () => {
            if (isTracking) {
                stopTracking();
            } else {
                startTracking();
            }
        });

        function startTracking() {
            if (!navigator.geolocation) {
                showError('ì´ ê¸°ê¸°ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            hideError();
            isTracking = true;
            startTime = Date.now();
            startBtn.textContent = 'â¸ ì¤‘ì§€';
            startBtn.classList.add('tracking');
            resetBtn.disabled = true;

            // íƒ€ì´ë¨¸ ì‹œì‘
            timerInterval = setInterval(updateStats, 1000);

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const newPoint = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        timestamp: position.timestamp,
                        accuracy: position.coords.accuracy
                    };

                    // ìœ„ì¹˜ ì •ë³´ í‘œì‹œ
                    locationInfo.classList.remove('hidden');
                    locationText.innerHTML = `
                        ìœ„ë„: ${newPoint.lat.toFixed(6)}Â°<br>
                        ê²½ë„: ${newPoint.lon.toFixed(6)}Â°<br>
                        ì •í™•ë„: Â±${newPoint.accuracy.toFixed(0)}m
                    `;

                    // ê±°ë¦¬ ê³„ì‚°
                    if (points.length > 0) {
                        const last = points[points.length - 1];
                        const dist = calculateDistance(last.lat, last.lon, newPoint.lat, newPoint.lon);
                        totalDistance += dist;
                    }

                    points.push(newPoint);
                    drawPath();
                    updateStats();
                    downloadBtn.disabled = false;

                    console.log('GPS ìœ„ì¹˜ ìˆ˜ì‹ :', newPoint);
                },
                (error) => {
                    console.error('GPS ì—ëŸ¬:', error);
                    showError(`GPS ì˜¤ë¥˜: ${error.message} (ì½”ë“œ: ${error.code})`);
                    stopTracking();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            isTracking = false;
            startBtn.textContent = 'â–¶ ì‹œì‘';
            startBtn.classList.remove('tracking');
            resetBtn.disabled = false;
        }

        // ë¦¬ì…‹
        resetBtn.addEventListener('click', () => {
            if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                stopTracking();
                points = [];
                totalDistance = 0;
                startTime = null;
                locationInfo.classList.add('hidden');
                downloadBtn.disabled = true;
                drawPath();
                updateStats();
                hideError();
            }
        });

        // ë‹¤ìš´ë¡œë“œ
        downloadBtn.addEventListener('click', () => {
            const data = {
                points: points,
                stats: {
                    distance: totalDistance,
                    pointCount: points.length,
                    duration: startTime ? Math.floor((Date.now() - startTime) / 1000) : 0
                },
                exportTime: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gps-track-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // ì´ˆê¸° ê·¸ë¦¬ê¸°
        drawPath();
        updateStats();

        console.log('GPS ì¶”ì ê¸° ì¤€ë¹„ ì™„ë£Œ');
        console.log('Geolocation ì§€ì›:', !!navigator.geolocation);
    </script>
</body>
</html>